<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title> donut test </title>
    <script src="http://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter2/1.4.7/crossfilter.min.js"></script>
</head>

<body>
    <script>
        async function make_donut_table(filename) {
            const DATA = await d3.csv(filename, type);
            var CF = crossfilter(DATA);
            var f = sum(DATA, 'fats');
            var p = sum(DATA, 'protein');
            var c = sum(DATA, 'carbohydrates');
            var o = sum(DATA, 'other');

            var data = {fats: f, protein: p, carbohydrates: c, other: o}
            var filtered = [];

            var width = 450,
            height = 450,
            margin = 40;

            var radius = Math.min(width, height) / 2 - margin;

            // append the svg object to the div called 'my_dataviz'
            var svg = d3.select("body")
                .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                .append("g")
                    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            // set the color scale
            const color = d3.schemePaired.slice(4);

            // Compute the position of each group on the pie:
            var pie = d3.pie()
                .value(function(d) { return d.value; })
                .sort(null);

            var arc = d3.arc()
                .innerRadius(100)
                .outerRadius(radius);

            var data_ready = pie(d3.entries(data))

            // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
            let path = svg.selectAll('sections')
                .data(data_ready)
              .enter().append('path')
                .attr('d', arc)
                .attr('fill', (d,i) => color[i])
                .attr("stroke", "black")
                .style("stroke-width", "2px")
                .style("opacity", 0.7)
                .each(function(d) { this._current = d; }) // store the initial angles
                .on('click', function(d, i) {
                    if (filtered.includes(d.data.key)) {
                        filtered.splice(filtered.indexOf(d.data.key),1)
                        d3.select(this).attr('fill', color[i])  
                    }
                    else {
                        filtered.push(d.data.key)
                        d3.select(this).attr('fill', 'lightblue')
                    }
                }
            ) 

            d3.selectAll("#buttonFats")
                .on("click", updateF);

            d3.selectAll("#buttonCarbs")
                .on("click", updateC);

            d3.selectAll("#buttonProtein")
                .on("click", updateP);

            d3.selectAll("#buttonOther")
                .on("click", updateO);

            function updateF() {update(0)}
            function updateC() {update(2)}
            function updateP() {update(1)}
            function updateO() {update(3)}

            function update(i) {
                data_ready[i].value += 50;
                path.data(pie(data_ready));
                path.transition().duration(750).attrTween("d", arcTween); // redraw the arcs
            }

            function arcTween(a) {
                var i = d3.interpolate(this._current, a);
                this._current = i(0);
                return function(t) {
                    return arc(i(t));
                };
            }
            
        }

        function sum(data, index) {
            var total = 0;
            for (i = 0; i < data.length; i++) {
                if (index == 'fats') {
                    total += data[i].fats;
                }
                else if (index == 'carbohydrates') {
                    total += data[i].carbohydrates;
                }
                else if (index == 'other') {
                    total += parseInt(data[i].other);
                }
                else {
                    total += data[i].protein;
                }           
            }
            return total;
        }

        function type(d) {
            d.fats = +d.fats;
            d.carbohydrates = +d.carbohydrates;
            d.protein = +d.protein;
            return d;
        }

        make_donut_table('data.csv');
    </script>

    <form>
        <button type="button" id="buttonFats"> +50 fats </button>
        <button type="button" id="buttonCarbs"> +50 carbs </button>
        <button type="button" id="buttonProtein"> +50 protein </button>
        <button type="button" id="buttonOther"> +50 other </button>
    </form>

</body>